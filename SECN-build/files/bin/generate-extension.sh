#!/bin/sh

# /bin/generate-extension.sh
# Generates lastoctet.extensions.conf include file for abbreviated dialling and echo test.

# Exit if Asterisk is not installed
if [ ! -d /etc/asterisk ]; then
	exit
fi 

# Get first three octets of IP address
OCTET123=`uci show network.lan.ipaddr | cut -d = -f 2 | cut -d . -f 1,2,3`

EXT="\${EXTEN}"
EXT4="\${EXTEN:4}"

# Create replacement conf file
# Everything from here to EOF will be written to the file
cat > /etc/asterisk/lastoctet.extensions.conf << EOF
; This file is generated by the script /bin/generate-extension.sh
; Do not edit, this file will be automatically overwritten when you reboot the device.

; This section is for placing a call using 1,2 or 3 digit dialling of last octet of MPs IP address.
exten => _X,1,Dial(SIP/4000@$OCTET123.$EXT)
exten => _XX,1,Dial(SIP/4000@$OCTET123.$EXT)
exten => _XXX,1,Dial(SIP/4000@$OCTET123.$EXT)

; This section is for the echo test 
; Local echo
exten => _3246,1,Answer()
exten => _3246,n,Playback(success)
exten => _3246,n,Echo() 
exten => _3246,n,Hangup()
;Remote echo
exten => _3246X,1,SIPAddHeader(Alert-Info: Echo)
exten => _3246X,n,Dial(SIP/s@$OCTET123.$EXT4)
exten => _3246XX,1,SIPAddHeader(Alert-Info: Echo)
exten => _3246XX,n,Dial(SIP/s@$OCTET123.$EXT4)
exten => _3246XXX,1,SIPAddHeader(Alert-Info: Echo)
exten => _3246XXX,n,Dial(SIP/s@$OCTET123.$EXT4)

; End of file
EOF

